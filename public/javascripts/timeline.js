// Generated by CoffeeScript 1.6.3
(function() {
  var app, socket;

  app = angular.module("app", []);

  socket = io.connect(location.host);

  /*
    Fillters
  */


  app.filter("toColorCode", function() {
    return function(input) {
      var c, cc, i, t;
      t = "abcdefghijklmnopqrstuvwxyz" + "ABCDEFGHIJKLMNOPQRSTUVWXYZ" + "0123456789";
      c = "";
      i = 0;
      while (i < input.length) {
        c += t.indexOf(input.charAt(i));
        i++;
      }
      c = parseInt(c).toString(16);
      cc = "#";
      i = 0;
      while (i < 6) {
        cc += c.charAt(i);
        i++;
      }
      return cc;
    };
  });

  app.filter("isAccess", function() {
    return function(input) {
      if (input) {
        return input;
      } else {
        return "アクセス";
      }
    };
  });

  app.filter("toIconClass", function() {
    return function(input) {
      if (input) {
        return "action";
      } else {
        return "traffic";
      }
    };
  });

  /*
    Timelime
  */


  app.controller("timelineController", function($rootScope, $scope, $http) {
    $scope.id = "liptonchilled.com";
    $scope.names = [];
    $scope.loading = false;
    $scope.last = new Date().getTime();
    $scope.load = function() {
      if ($scope.loading) {
        return false;
      }
      $scope.loading = true;
      return $http({
        method: "GET",
        url: "/api/traffic.json?id=" + $scope.id + "&timestamp=" + $scope.last
      }).success(function(data, status, headers, config) {
        if (data.length > 0) {
          $scope.last = data[data.length - 1].timestamp["N"];
          Array.prototype.push.apply($scope.names, data);
        }
        return setTimeout(function() {
          return $scope.loading = false;
        }, 500);
      }).error(function(data, status, headers, config) {
        console.log(status);
        return setTimeout(function() {
          return $scope.loading = false;
        }, 500);
      });
    };
    $scope.show = function(label_id) {
      return $rootScope.$broadcast("select_label_id", label_id);
    };
    socket.on("update", function(data) {
      return $scope.$apply(function() {
        return $scope.names.unshift(data);
      });
    });
    if ($scope.id) {
      return $scope.load();
    }
  });

  /*
    Individual
  */


  app.controller("individualController", function($scope, $http) {
    $scope.id = "liptonchilled.com";
    $scope.label_id = "";
    $scope.labels = [];
    $scope.names = [];
    $scope.loading = false;
    $scope.last = new Date().getTime();
    $scope.load = function() {
      if ($scope.loading || $scope.label_id === "") {
        return false;
      }
      $scope.loading = true;
      return $http({
        method: "GET",
        url: "/api/individual.json?id=" + $scope.id + "&label_id=" + $scope.label_id
      }).success(function(data, status, headers, config) {
        if (data["traffics"].length > 0) {
          console.log(data);
          $scope.last = data["traffics"][data["traffics"].length - 1].timestamp["N"];
          $scope.names = data["traffics"];
          $scope.labels = data["labels"];
        }
        return setTimeout(function() {
          return $scope.loading = false;
        }, 500);
      }).error(function(data, status, headers, config) {
        return setTimeout(function() {
          return $scope.loading = false;
        }, 500);
      });
    };
    $scope.$on("select_label_id", function(event, label_id) {
      if ($scope.label_id === label_id || $scope.loading) {
        return false;
      }
      $scope.label_id = label_id;
      return $scope.load();
    });
    socket.on("update", function(data) {
      if (data.label_id["S"] === $scope.label_id) {
        return $scope.$apply(function() {
          return $scope.names.unshift(data);
        });
      }
    });
    if ($scope.label_id) {
      return $scope.load();
    }
  });

}).call(this);
